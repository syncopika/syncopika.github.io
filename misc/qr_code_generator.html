<!doctype html>

<html>

<head>
  <title> QR code generator (WIP) </title>
  
  <style>
    body {
      text-align: center;
    }
    
    canvas {
      display: block;
      margin: 20px auto;
      border: 1px solid #ccc;
    }
  </style>
</head>

<body>
  <h1> QR code generator (WIP) </h1>
  <p> hi, nothing to see here yet :) </p>
  <input type='text' />
  <button onclick="init()"> generate </button>
</body>

<script>
// https://www.thonky.com/qr-code-tutorial/introduction
// https://www.qrcode.com/en/about/version.html

// tables

// https://www.thonky.com/qr-code-tutorial/character-capacities
// map QR version to error correction level + max char capacity
const characterCapacities = {
  1: {
    "L": 17, // only assuming byte mode atm
    "M": 14,
    "Q": 11,
    "H": 7,
  },
  2: {
    "L": 32,
    "M": 26,
    "Q": 20,
    "H": 14,
  },
  3: {
    "L": 53,
    "M": 42,
    "Q": 32,
    "H": 24,
  },
  4: {
    "L": 78,
    "M": 62,
    "Q": 46,
    "H": 34,
  },
  5: {
    "L": 106,
    "M": 84,
    "Q": 60,
    "H": 44,
  },
  6: {
    "L": 134,
    "M": 106,
    "Q": 74,
    "H": 58,
  },
  7: {
    "L": 154,
    "M": 122,
    "Q": 86,
    "H": 64,
  },
  8: {
    "L": 192,
    "M": 152,
    "Q": 108,
    "H": 84,
  },
  9: {
    "L": 230,
    "M": 180,
    "Q": 130,
    "H": 98,
  },
  10: {
    "L": 271,
    "M": 213,
    "Q": 151,
    "H": 119,
  },
  11: {
    "L": 321,
    "M": 251,
    "Q": 177,
    "H": 137,
  },
  12: {
    "L": 367,
    "M": 287,
    "Q": 203,
    "H": 155,
  },
  13: {
    "L": 425,
    "M": 331,
    "Q": 241,
    "H": 177,
  },
  14: {
    "L": 458,
    "M": 362,
    "Q": 258,
    "H": 194,
  },
  15: {
    "L": 520,
    "M": 412,
    "Q": 292,
    "H": 220,
  },
  16: {
    "L": 586,
    "M": 450,
    "Q": 322,
    "H": 250,
  },
  17: {
    "L": 644,
    "M": 504,
    "Q": 364,
    "H": 280,
  },
  18: {
    "L": 718,
    "M": 560,
    "Q": 394,
    "H": 310,
  },
  19: {
    "L": 792,
    "M": 624,
    "Q": 442,
    "H": 338,
  },
  20: {
    "L": 858,
    "M": 666,
    "Q": 482,
    "H": 382,
  },
  21: {
    "L": 929,
    "M": 711,
    "Q": 509,
    "H": 403,
  },
  22: {
    "L": 1003,
    "M": 779,
    "Q": 565,
    "H": 439,
  },
  23: {
    "L": 1091,
    "M": 857,
    "Q": 611,
    "H": 461,
  },
  24: {
    "L": 1171,
    "M": 911,
    "Q": 661,
    "H": 511,
  },
  25: {
    "L": 1273,
    "M": 997,
    "Q": 715,
    "H": 535,
  },
  26: {
    "L": 1367,
    "M": 1059,
    "Q": 751,
    "H": 593,
  },
  27: {
    "L": 1465,
    "M": 1125,
    "Q": 805,
    "H": 625,
  },
  28: {
    "L": 1528,
    "M": 1190,
    "Q": 868,
    "H": 658,
  },
  29: {
    "L": 1628,
    "M": 1264,
    "Q": 908,
    "H": 698,
  },
  30: {
    "L": 1732,
    "M": 1370,
    "Q": 982,
    "H": 742,
  },
  31: {
    "L": 1840,
    "M": 1452,
    "Q": 1030,
    "H": 790,
  },
  32: {
    "L": 1952,
    "M": 1538,
    "Q": 112,
    "H": 842,
  },
  33: {
    "L": 2068,
    "M": 1628,
    "Q": 1168,
    "H": 898,
  },
  34: {
    "L": 2188,
    "M": 1722,
    "Q": 1228,
    "H": 958,
  },
  35: {
    "L": 2303,
    "M": 1809,
    "Q": 1283,
    "H": 983,
  },
  36: {
    "L": 2431,
    "M": 1911,
    "Q": 1351,
    "H": 1051,
  },
  37: {
    "L": 2563,
    "M": 1989,
    "Q": 1423,
    "H": 1093,
  },
  38: {
    "L": 2699,
    "M": 2099,
    "Q": 1499,
    "H": 1139,
  },
  39: {
    "L": 2809,
    "M": 2213,
    "Q": 1579,
    "H": 1219,
  },
  40: {
    "L": 2953,
    "M": 2331,
    "Q": 1663,
    "H": 1273,
  },
};

// only caring about byte mode atm
const versionCharCountIndicatorSizeMap = {
  1: 8, // version 1 -> 8 bits for representing the character count
  10: 16, // versions 10 - 26 -> 16 bits
  27: 16, // versions 27 - 40 -> 16 bits
};

function intToBinary(n){
  // TODO: need to pad up to certain num of bits based on version
}

function init(){
  // create the canvas to draw the QR code in
  const canvas = document.createElement('canvas'); 
  const ctx = canvas.getContext('2d');
  
  // set bg to black
  ctx.fillStyle = 'rgb(0,0,0)';
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  
  // TODO: how do we know how big the canvas should be?
  // size of a QR code can be calculated with ((V - 1) * 4) + 21
  // where V is the QR code version
  
  // let's default to "byte mode" for now (that is, only support strings with characters from ISO-8859-1 character set)
  const mode = "0100"; // mode indicator (4 bits)
  
  // let's default to level M for error correction (L - 7% data recovery, M - 15%, Q - 25%, H - 30%)
  // the higher the error correction level, the larger the QR code will be (b/c it takes more bytes)
  const errorCorrectionLevel = "M";
  
  // TODO: need character count indicator
  
  // figure out QR code version/size
  
  
  drawFinderPatterns(ctx, canvas.width, canvas.height);
  
  document.body.appendChild(canvas);
}

function getCharacterCapacityForVersion(version){
  // TODO
}

function drawFinderPatterns(ctx, width, height){
  // finder patterns are always 7 x 7
  // with an inner white square of 5 x 5
  // and a solid black square in the center that's 3 x 3
  // finder patterns are also always surrounded by a separator, which is just a white line
  const separatorDim = 8;
  const finderOuterDim = 7;
  const finderInnerDim = 5;
  const finderInnerCenter = 3;
  
  // draw top-right corner pattern
  ctx.fillStyle = 'rgb(255,255,255)'; // draw separator first
  ctx.fillRect(width - finderOuterDim - 1, 0, separatorDim, separatorDim);
  
  ctx.fillStyle = 'rgb(0,0,0)';
  ctx.fillRect(width - finderOuterDim, 0, finderOuterDim, finderOuterDim);
  
  ctx.fillStyle = 'rgb(255,255,255)';
  ctx.fillRect(width - finderOuterDim + 1, 1, finderInnerDim, finderInnerDim);
  
  ctx.fillStyle = 'rgb(0,0,0)';
  ctx.fillRect(width - finderOuterDim + 2, 2, finderInnerCenter, finderInnerCenter);
  
  // draw top-left corner pattern
  ctx.fillStyle = 'rgb(255,255,255)'; // draw separator first
  ctx.fillRect(0, 0, separatorDim, separatorDim);
  
  ctx.fillStyle = 'rgb(0,0,0)';
  ctx.fillRect(0, 0, finderOuterDim, finderOuterDim);
  
  ctx.fillStyle = 'rgb(255,255,255)';
  ctx.fillRect(1, 1, finderInnerDim, finderInnerDim);
  
  ctx.fillStyle = 'rgb(0,0,0)';
  ctx.fillRect(2, 2, finderInnerCenter, finderInnerCenter);
  
  // draw bottom-left corner pattern
  ctx.fillStyle = 'rgb(255,255,255)'; // draw separator first
  ctx.fillRect(0, height - finderOuterDim - 1, separatorDim, separatorDim);
  
  ctx.fillStyle = 'rgb(0,0,0)';
  ctx.fillRect(0, height - finderOuterDim, finderOuterDim, finderOuterDim);
  
  ctx.fillStyle = 'rgb(255,255,255)';
  ctx.fillRect(1, height - finderOuterDim + 1, finderInnerDim, finderInnerDim);
  
  ctx.fillStyle = 'rgb(0,0,0)';
  ctx.fillRect(2, height - finderOuterDim + 2, finderInnerCenter, finderInnerCenter);  
}

function addAlignmentPatterns(){
  // TODO
  // QR codes that are >= version 2 are required to have alignment patterns
  // an alignment pattern is a 5 x 5 black square with a 3 x 3 white square inside and a black squar e in the center
}

function addTimingPatterns(){
  // TODO
}

function addDarkModuleAndReservedAreas(){
  // TODO
}

function addData(){
  // TODO
}

</script>


</html>